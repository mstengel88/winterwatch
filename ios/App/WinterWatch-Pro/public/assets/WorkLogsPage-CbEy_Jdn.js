import{r as m,j as e,B as X,C as D,b as T,I as Y,T as Z,i as ee,k as g,l as se,m as te,n as ae,L as re,s as S,f as M}from"./index-BTTndiCa.js";import{A as ne,C as le}from"./AppLayout-CdmLHGoC.js";import{S as P,a as $,b as I,c as F,d as o,B as h}from"./select-CkuTWz4P.js";import{T as ce,a as ie,b as q,c as u,d as de,e as p}from"./table-ByQioMfz.js";import{F as oe,a as me,g as he}from"./pdfExport-BOAci1lN.js";import{S as ue}from"./search-CUdo4Vh7.js";import{C as pe,s as xe,e as _e}from"./subDays-BQ2HQSuo.js";import{T as B}from"./truck-GV-QDD0s.js";import{S as E}from"./shovel-CsAXD17G.js";import{M as fe}from"./map-pin-Dw0f1SUM.js";import{C as be}from"./clock-91DdfKYf.js";import{f as b,s as je}from"./format-D46ChU1D.js";import"./index-C_FqIwIg.js";import"./Combination-BI3QGdrN.js";import"./user-MPZ2r4HK.js";import"./log-out-D3n32clD.js";function qe(){const[j,A]=m.useState([]),[H,L]=m.useState(!0),[v,R]=m.useState(""),[x,V]=m.useState("7"),[y,O]=m.useState("all"),[w,W]=m.useState("all"),U=async()=>{L(!0);try{const s=parseInt(x),a=je(xe(new Date,s-1)).toISOString(),l=_e(new Date).toISOString(),[c,d]=await Promise.all([S.from("work_logs").select("*, employee:employees(first_name, last_name), account:accounts(name, address), equipment:equipment(name)").gte("created_at",a).lte("created_at",l).order("created_at",{ascending:!1}),S.from("shovel_work_logs").select("*, employee:employees(first_name, last_name), account:accounts(name, address)").gte("created_at",a).lte("created_at",l).order("created_at",{ascending:!1})]),t=Array.from(new Set((d.data||[]).flatMap(i=>i.team_member_ids||[]))),r=new Map;if(t.length>0){const{data:i,error:f}=await S.from("employees").select("id, first_name, last_name").in("id",t);if(!f&&i)for(const N of i)r.set(N.id,`${N.first_name} ${N.last_name}`)}const _=(c.data||[]).map(i=>({...i,type:"plow",equipment:i.equipment})),K=(d.data||[]).map(i=>({...i,type:"shovel",equipment:null,snow_depth_inches:null,salt_used_lbs:null,teamMemberNames:(i.team_member_ids||[]).map(f=>r.get(f)).filter(Boolean)})),Q=[..._,...K].sort((i,f)=>new Date(f.created_at).getTime()-new Date(i.created_at).getTime());A(Q)}catch(s){console.error("Error fetching logs:",s),M.error("Failed to load work logs")}finally{L(!1)}};m.useEffect(()=>{U()},[x]);const n=j.filter(s=>{var a,l;if(w==="plow"&&s.type!=="plow"||w==="shovel"&&s.type!=="shovel"||y!=="all"&&s.status!==y)return!1;if(v){const c=v.toLowerCase(),d=((l=(a=s.account)==null?void 0:a.name)==null?void 0:l.toLowerCase())||"",t=s.employee?`${s.employee.first_name} ${s.employee.last_name}`.toLowerCase():"";if(!d.includes(c)&&!t.includes(c))return!1}return!0}),k=(s,a)=>{if(!s||!a)return"-";const l=new Date(a).getTime()-new Date(s).getTime(),c=Math.floor(l/(1e3*60*60)),d=Math.floor(l%(1e3*60*60)/(1e3*60));return c>0?`${c}h ${d}m`:`${d}m`},z=s=>{switch(s){case"completed":return e.jsx(h,{className:"bg-green-500/20 text-green-400 border-green-500/30",children:"Completed"});case"in_progress":return e.jsx(h,{className:"bg-blue-500/20 text-blue-400 border-blue-500/30",children:"In Progress"});case"pending":return e.jsx(h,{className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30",children:"Pending"});case"cancelled":return e.jsx(h,{className:"bg-red-500/20 text-red-400 border-red-500/30",children:"Cancelled"});default:return e.jsx(h,{variant:"outline",children:s})}},C=(s,a)=>{if(s==="plow")switch(a){case"plow":return"Plow";case"salt":return"Salt";case"both":return"Plow/Salt";default:return a}else switch(a){case"shovel":return"Shovel";case"ice_melt":return"Salt";case"both":return"Shovel/Salt";default:return a}},J=s=>{const a=C(s.type,s.service_type);return s.type==="shovel"?e.jsxs(h,{className:"bg-shovel/20 text-shovel border-shovel/30",children:[e.jsx(E,{className:"h-3 w-3 mr-1"}),a]}):e.jsxs(h,{className:"bg-plow/20 text-plow border-plow/30",children:[e.jsx(B,{className:"h-3 w-3 mr-1"}),a]})},G=()=>{const s=n.map(t=>{var r,_;return{id:t.id,type:t.type,date:b(new Date(t.created_at),"MM/dd/yy"),checkIn:t.check_in_time?b(new Date(t.check_in_time),"HH:mm"):"-",checkOut:t.check_out_time?b(new Date(t.check_out_time),"HH:mm"):"-",duration:k(t.check_in_time,t.check_out_time),account:((r=t.account)==null?void 0:r.name)||"Unknown",serviceType:C(t.type,t.service_type),snowDepth:t.snow_depth_inches?`${t.snow_depth_inches}"`:"-",saltLbs:t.salt_used_lbs?`${t.salt_used_lbs}lb`:t.ice_melt_used_lbs?`${t.ice_melt_used_lbs}lb`:"-",equipment:((_=t.equipment)==null?void 0:_.name)||"-",employee:t.type==="shovel"&&t.teamMemberNames&&t.teamMemberNames.length>0?t.teamMemberNames.join(", "):t.employee?`${t.employee.first_name} ${t.employee.last_name}`:"Unknown",conditions:"-",notes:t.notes||void 0}});n.reduce((t,r)=>{if(r.check_in_time&&r.check_out_time){const _=new Date(r.check_out_time).getTime()-new Date(r.check_in_time).getTime();return t+_/(1e3*60*60)}return t},0);const a=x==="7"?"Last 7 days":x==="14"?"Last 14 days":x==="30"?"Last 30 days":"Last 90 days",l=new Set(n.map(t=>{var r;return(r=t.account)==null?void 0:r.name})).size,c=n.filter(t=>t.service_type==="plow"||t.service_type==="both").length,d=n.filter(t=>t.service_type==="salt"||t.service_type==="ice_melt"||t.service_type==="both").length;he(s,{totalJobs:n.length,totalSaltLbs:n.reduce((t,r)=>t+(r.salt_used_lbs||0),0),totalIceMeltLbs:n.reduce((t,r)=>t+(r.ice_melt_used_lbs||0),0),plowCount:c,saltCount:d,propertyCount:l,dateRange:a}),M.success("PDF exported successfully")};return e.jsx(ne,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(le,{className:"h-6 w-6 text-primary"}),"Work Logs"]}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage all service records"})]}),e.jsxs(X,{variant:"outline",onClick:G,disabled:n.length===0,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Export PDF"]})]}),e.jsx(D,{className:"bg-card/50 border-border/50",children:e.jsx(T,{className:"pt-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Y,{placeholder:"Search by account or employee...",value:v,onChange:s=>R(s.target.value),className:"pl-9 bg-background/50"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{value:x,onValueChange:V,children:[e.jsxs($,{className:"w-[140px] bg-background/50",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),e.jsx(I,{})]}),e.jsxs(F,{children:[e.jsx(o,{value:"7",children:"Last 7 days"}),e.jsx(o,{value:"14",children:"Last 14 days"}),e.jsx(o,{value:"30",children:"Last 30 days"}),e.jsx(o,{value:"90",children:"Last 90 days"})]})]}),e.jsxs(P,{value:y,onValueChange:O,children:[e.jsxs($,{className:"w-[130px] bg-background/50",children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),e.jsx(I,{})]}),e.jsxs(F,{children:[e.jsx(o,{value:"all",children:"All Status"}),e.jsx(o,{value:"completed",children:"Completed"}),e.jsx(o,{value:"in_progress",children:"In Progress"}),e.jsx(o,{value:"pending",children:"Pending"}),e.jsx(o,{value:"cancelled",children:"Cancelled"})]})]})]})]})})}),e.jsxs(Z,{value:w,onValueChange:W,children:[e.jsxs(ee,{className:"bg-muted/50",children:[e.jsxs(g,{value:"all",className:"data-[state=active]:bg-background",children:["All Logs (",j.length,")"]}),e.jsxs(g,{value:"plow",className:"data-[state=active]:bg-plow/20 data-[state=active]:text-plow",children:[e.jsx(B,{className:"h-4 w-4 mr-1"}),"Plow (",j.filter(s=>s.type==="plow").length,")"]}),e.jsxs(g,{value:"shovel",className:"data-[state=active]:bg-shovel/20 data-[state=active]:text-shovel",children:[e.jsx(E,{className:"h-4 w-4 mr-1"}),"Shovel (",j.filter(s=>s.type==="shovel").length,")"]})]}),e.jsx(se,{value:w,className:"mt-4",children:e.jsxs(D,{className:"bg-card/50 border-border/50",children:[e.jsx(te,{className:"pb-3",children:e.jsxs(ae,{className:"text-base font-medium",children:[n.length," record",n.length!==1?"s":""," found"]})}),e.jsx(T,{children:H?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(re,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):n.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"No work logs found matching your criteria."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ce,{children:[e.jsx(ie,{children:e.jsxs(q,{className:"border-border/50 hover:bg-transparent",children:[e.jsx(u,{children:"Date"}),e.jsx(u,{children:"Account"}),e.jsx(u,{children:"Employee"}),e.jsx(u,{children:"Service"}),e.jsx(u,{children:"Duration"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Details"})]})}),e.jsx(de,{children:n.map(s=>{var a,l,c;return e.jsxs(q,{className:"border-border/50",children:[e.jsxs(p,{className:"font-medium",children:[b(new Date(s.created_at),"MM/dd/yy"),e.jsx("div",{className:"text-xs text-muted-foreground",children:b(new Date(s.created_at),"h:mm a")})]}),e.jsxs(p,{children:[e.jsx("div",{className:"font-medium",children:((a=s.account)==null?void 0:a.name)||"-"}),((l=s.account)==null?void 0:l.address)&&e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(fe,{className:"h-3 w-3"}),s.account.address.slice(0,30),"..."]})]}),e.jsx(p,{children:s.type==="shovel"&&s.teamMemberNames&&s.teamMemberNames.length>0?s.teamMemberNames.join(", "):s.employee?`${s.employee.first_name} ${s.employee.last_name}`:"-"}),e.jsx(p,{children:J(s)}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(be,{className:"h-3 w-3 text-muted-foreground"}),k(s.check_in_time,s.check_out_time)]})}),e.jsx(p,{children:z(s.status)}),e.jsx(p,{children:e.jsxs("div",{className:"text-xs text-muted-foreground space-y-0.5",children:[s.type==="plow"&&s.salt_used_lbs&&e.jsxs("div",{children:["Salt: ",s.salt_used_lbs," lbs"]}),s.type==="plow"&&s.snow_depth_inches&&e.jsxs("div",{children:["Snow: ",s.snow_depth_inches,'"']}),s.type==="shovel"&&s.ice_melt_used_lbs&&e.jsxs("div",{children:["Ice Melt: ",s.ice_melt_used_lbs," lbs"]}),((c=s.equipment)==null?void 0:c.name)&&e.jsxs("div",{children:["Equip: ",s.equipment.name]})]})})]},s.id)})})]})})})]})})]})]})})}export{qe as default};
