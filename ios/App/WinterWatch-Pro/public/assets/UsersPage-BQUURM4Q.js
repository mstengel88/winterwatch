import{r as n,j as e,L as x,C as T,m as U,n as E,o as $,b as B,B as L,s as i,f as o,U as A}from"./index-BTTndiCa.js";import{B as P,S as k,a as z,b as F,c as H,d as q}from"./select-CkuTWz4P.js";import{T as I,a as V,b as N,c as u,d as D,e as f}from"./table-ByQioMfz.js";import{a as M,U as O,S as W}from"./user-MPZ2r4HK.js";import{T as G}from"./trash-2-RpLMvkye.js";import{P as J}from"./plus-DnkJBOXp.js";import{S as K}from"./shovel-CsAXD17G.js";import{T as Q}from"./truck-GV-QDD0s.js";import"./Combination-BI3QGdrN.js";const X=["admin","manager","driver","shovel_crew","client"],Y=t=>{switch(t){case"admin":return e.jsx(W,{className:"h-3 w-3"});case"manager":return e.jsx(A,{className:"h-3 w-3"});case"driver":return e.jsx(Q,{className:"h-3 w-3"});case"shovel_crew":return e.jsx(K,{className:"h-3 w-3"});default:return e.jsx(O,{className:"h-3 w-3"})}},Z=t=>{switch(t){case"admin":return"bg-destructive text-destructive-foreground";case"manager":return"bg-warning text-warning-foreground";case"driver":return"bg-plow text-plow-foreground";case"shovel_crew":return"bg-shovel text-shovel-foreground";default:return"bg-secondary text-secondary-foreground"}};function ie(){const[t,S]=n.useState([]),[b,j]=n.useState(!0),[c,p]=n.useState(null),[y,g]=n.useState(null),[d,w]=n.useState({}),m=async()=>{j(!0);try{const{data:s,error:r}=await i.from("profiles").select("*").order("created_at",{ascending:!1});if(r)throw r;const{data:a,error:l}=await i.from("user_roles").select("user_id, role");if(l)throw l;const _=(s||[]).map(v=>({...v,roles:(a||[]).filter(h=>h.user_id===v.id).map(h=>h.role)}));S(_)}catch(s){console.error("Error fetching users:",s),o.error("Failed to load users")}finally{j(!1)}};n.useEffect(()=>{m()},[]);const C=async s=>{const r=d[s];if(!r){o.error("Please select a role");return}p({userId:s,role:r});try{const{error:a}=await i.from("user_roles").insert({user_id:s,role:r});if(a){if(a.code==="23505")o.error("User already has this role");else throw a;return}o.success(`Added ${r} role`),w(l=>({...l,[s]:""})),m()}catch(a){console.error("Error adding role:",a),o.error("Failed to add role")}finally{p(null)}},R=async(s,r)=>{const a=`${s}-${r}`;g(a);try{const{error:l}=await i.from("user_roles").delete().eq("user_id",s).eq("role",r);if(l)throw l;o.success(`Removed ${r} role`),m()}catch(l){console.error("Error removing role:",l),o.error("Failed to remove role")}finally{g(null)}};return b?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(x,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Users & Roles"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage user accounts and assign roles"})]}),e.jsxs(T,{children:[e.jsxs(U,{children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-5 w-5"}),"All Users"]}),e.jsxs($,{children:[t.length," registered user",t.length!==1?"s":""]})]}),e.jsx(B,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(I,{children:[e.jsx(V,{children:e.jsxs(N,{children:[e.jsx(u,{children:"User"}),e.jsx(u,{children:"Current Roles"}),e.jsx(u,{children:"Add Role"})]})}),e.jsx(D,{children:t.map(s=>e.jsxs(N,{children:[e.jsx(f,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.full_name||"No name"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.email})]})}),e.jsx(f,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:s.roles.length>0?s.roles.map(r=>e.jsxs(P,{className:`${Z(r)} cursor-pointer`,onClick:()=>R(s.id,r),children:[Y(r),e.jsx("span",{className:"ml-1 capitalize",children:r.replace("_"," ")}),y===`${s.id}-${r}`?e.jsx(x,{className:"ml-1 h-3 w-3 animate-spin"}):e.jsx(G,{className:"ml-1 h-3 w-3"})]},r)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"No roles"})})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(k,{value:d[s.id]||"",onValueChange:r=>w(a=>({...a,[s.id]:r})),children:[e.jsx(z,{className:"w-[140px]",children:e.jsx(F,{placeholder:"Select role"})}),e.jsx(H,{children:X.filter(r=>!s.roles.includes(r)).map(r=>e.jsx(q,{value:r,children:e.jsx("span",{className:"capitalize",children:r.replace("_"," ")})},r))})]}),e.jsx(L,{size:"sm",onClick:()=>C(s.id),disabled:!d[s.id]||(c==null?void 0:c.userId)===s.id,children:(c==null?void 0:c.userId)===s.id?e.jsx(x,{className:"h-4 w-4 animate-spin"}):e.jsx(J,{className:"h-4 w-4"})})]})})]},s.id))})]})})})]})]})}export{ie as default};
