import{r as m,j as e,A as X,G as Y,k as Z,C as D,g as T,I as ee,S as M,p as P,q as $,t as I,v as i,H as se,J as te,K as g,M as q,E as F,O as ae,Q as re,R as ne,L as le,w as b,i as ce,U as ie,s as S,V as E,B as h}from"./index-CnGaZqSN.js";import{T as de,a as oe,b as A,c as u,d as me,e as x}from"./table-Cg0xew9Q.js";import{F as he,a as ue,g as xe}from"./pdfExport-Pv2pQLSC.js";import{S as pe}from"./search-Di4xWTr4.js";import{C as _e,s as be,e as je}from"./subDays-BHzbpdNt.js";import{M as fe}from"./map-pin-CNhKVerA.js";function Le(){const[j,B]=m.useState([]),[H,L]=m.useState(!0),[w,R]=m.useState(""),[p,V]=m.useState("7"),[v,O]=m.useState("all"),[f,U]=m.useState("all"),W=async()=>{L(!0);try{const s=parseInt(p),a=ie(be(new Date,s-1)).toISOString(),c=je(new Date).toISOString(),[d,o]=await Promise.all([S.from("work_logs").select("*, employee:employees(first_name, last_name), account:accounts(name, address), equipment:equipment(name)").gte("created_at",a).lte("created_at",c).order("created_at",{ascending:!1}),S.from("shovel_work_logs").select("*, employee:employees(first_name, last_name), account:accounts(name, address)").gte("created_at",a).lte("created_at",c).order("created_at",{ascending:!1})]),t=Array.from(new Set((o.data||[]).flatMap(n=>n.team_member_ids||[]))),l=new Map;if(t.length>0){const{data:n,error:_}=await S.from("employees").select("id, first_name, last_name").in("id",t);if(!_&&n)for(const N of n)l.set(N.id,`${N.first_name} ${N.last_name}`)}const y=(d.data||[]).map(n=>({...n,type:"plow",equipment:n.equipment})),K=(o.data||[]).map(n=>({...n,type:"shovel",equipment:null,snow_depth_inches:null,salt_used_lbs:null,teamMemberNames:(n.team_member_ids||[]).map(_=>l.get(_)).filter(Boolean)})),Q=[...y,...K].sort((n,_)=>new Date(_.created_at).getTime()-new Date(n.created_at).getTime());B(Q)}catch(s){console.error("Error fetching logs:",s),E.error("Failed to load work logs")}finally{L(!1)}};m.useEffect(()=>{W()},[p]);const r=j.filter(s=>{if(f==="plow"&&s.type!=="plow"||f==="shovel"&&s.type!=="shovel"||v!=="all"&&s.status!==v)return!1;if(w){const a=w.toLowerCase(),c=s.account?.name?.toLowerCase()||"",d=s.employee?`${s.employee.first_name} ${s.employee.last_name}`.toLowerCase():"";if(!c.includes(a)&&!d.includes(a))return!1}return!0}),k=(s,a)=>{if(!s||!a)return"-";const c=new Date(a).getTime()-new Date(s).getTime(),d=Math.floor(c/(1e3*60*60)),o=Math.floor(c%(1e3*60*60)/(1e3*60));return d>0?`${d}h ${o}m`:`${o}m`},J=s=>{switch(s){case"completed":return e.jsx(h,{className:"bg-green-500/20 text-green-400 border-green-500/30",children:"Completed"});case"in_progress":return e.jsx(h,{className:"bg-blue-500/20 text-blue-400 border-blue-500/30",children:"In Progress"});case"pending":return e.jsx(h,{className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30",children:"Pending"});case"cancelled":return e.jsx(h,{className:"bg-red-500/20 text-red-400 border-red-500/30",children:"Cancelled"});default:return e.jsx(h,{variant:"outline",children:s})}},C=(s,a)=>{if(s==="plow")switch(a){case"plow":return"Plow";case"salt":return"Salt";case"both":return"Plow/Salt";default:return a}else switch(a){case"shovel":return"Shovel";case"ice_melt":return"Salt";case"both":return"Shovel/Salt";default:return a}},z=s=>{const a=C(s.type,s.service_type);return s.type==="shovel"?e.jsxs(h,{className:"bg-shovel/20 text-shovel border-shovel/30",children:[e.jsx(F,{className:"h-3 w-3 mr-1"}),a]}):e.jsxs(h,{className:"bg-plow/20 text-plow border-plow/30",children:[e.jsx(q,{className:"h-3 w-3 mr-1"}),a]})},G=()=>{const s=r.map(t=>({id:t.id,type:t.type,date:b(new Date(t.created_at),"MM/dd/yy"),checkIn:t.check_in_time?b(new Date(t.check_in_time),"HH:mm"):"-",checkOut:t.check_out_time?b(new Date(t.check_out_time),"HH:mm"):"-",duration:k(t.check_in_time,t.check_out_time),account:t.account?.name||"Unknown",serviceType:C(t.type,t.service_type),snowDepth:t.snow_depth_inches?`${t.snow_depth_inches}"`:"-",saltLbs:t.salt_used_lbs?`${t.salt_used_lbs}lb`:t.ice_melt_used_lbs?`${t.ice_melt_used_lbs}lb`:"-",equipment:t.equipment?.name||"-",employee:t.type==="shovel"&&t.teamMemberNames&&t.teamMemberNames.length>0?t.teamMemberNames.join(", "):t.employee?`${t.employee.first_name} ${t.employee.last_name}`:"Unknown",conditions:"-",notes:t.notes||void 0}));r.reduce((t,l)=>{if(l.check_in_time&&l.check_out_time){const y=new Date(l.check_out_time).getTime()-new Date(l.check_in_time).getTime();return t+y/(1e3*60*60)}return t},0);const a=p==="7"?"Last 7 days":p==="14"?"Last 14 days":p==="30"?"Last 30 days":"Last 90 days",c=new Set(r.map(t=>t.account?.name)).size,d=r.filter(t=>t.service_type==="plow"||t.service_type==="both").length,o=r.filter(t=>t.service_type==="salt"||t.service_type==="ice_melt"||t.service_type==="both").length;xe(s,{totalJobs:r.length,totalSaltLbs:r.reduce((t,l)=>t+(l.salt_used_lbs||0),0),totalIceMeltLbs:r.reduce((t,l)=>t+(l.ice_melt_used_lbs||0),0),plowCount:d,saltCount:o,propertyCount:c,dateRange:a}),E.success("PDF exported successfully")};return e.jsx(X,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Y,{className:"h-6 w-6 text-primary"}),"Work Logs"]}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage all service records"})]}),e.jsxs(Z,{variant:"outline",onClick:G,disabled:r.length===0,children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Export PDF"]})]}),e.jsx(D,{className:"bg-card/50 border-border/50",children:e.jsx(T,{className:"pt-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ee,{placeholder:"Search by account or employee...",value:w,onChange:s=>R(s.target.value),className:"pl-9 bg-background/50"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(M,{value:p,onValueChange:V,children:[e.jsxs(P,{className:"w-[140px] bg-background/50",children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),e.jsx($,{})]}),e.jsxs(I,{children:[e.jsx(i,{value:"7",children:"Last 7 days"}),e.jsx(i,{value:"14",children:"Last 14 days"}),e.jsx(i,{value:"30",children:"Last 30 days"}),e.jsx(i,{value:"90",children:"Last 90 days"})]})]}),e.jsxs(M,{value:v,onValueChange:O,children:[e.jsxs(P,{className:"w-[130px] bg-background/50",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),e.jsx($,{})]}),e.jsxs(I,{children:[e.jsx(i,{value:"all",children:"All Status"}),e.jsx(i,{value:"completed",children:"Completed"}),e.jsx(i,{value:"in_progress",children:"In Progress"}),e.jsx(i,{value:"pending",children:"Pending"}),e.jsx(i,{value:"cancelled",children:"Cancelled"})]})]})]})]})})}),e.jsxs(se,{value:f,onValueChange:U,children:[e.jsxs(te,{className:"bg-muted/50",children:[e.jsxs(g,{value:"all",className:"data-[state=active]:bg-background",children:["All Logs (",j.length,")"]}),e.jsxs(g,{value:"plow",className:"data-[state=active]:bg-plow/20 data-[state=active]:text-plow",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"Plow (",j.filter(s=>s.type==="plow").length,")"]}),e.jsxs(g,{value:"shovel",className:"data-[state=active]:bg-shovel/20 data-[state=active]:text-shovel",children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Shovel (",j.filter(s=>s.type==="shovel").length,")"]})]}),e.jsx(ae,{value:f,className:"mt-4",children:e.jsxs(D,{className:"bg-card/50 border-border/50",children:[e.jsx(re,{className:"pb-3",children:e.jsxs(ne,{className:"text-base font-medium",children:[r.length," record",r.length!==1?"s":""," found"]})}),e.jsx(T,{children:H?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(le,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):r.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"No work logs found matching your criteria."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(A,{className:"border-border/50 hover:bg-transparent",children:[e.jsx(u,{children:"Date"}),e.jsx(u,{children:"Account"}),e.jsx(u,{children:"Employee"}),e.jsx(u,{children:"Service"}),e.jsx(u,{children:"Duration"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Details"})]})}),e.jsx(me,{children:r.map(s=>e.jsxs(A,{className:"border-border/50",children:[e.jsxs(x,{className:"font-medium",children:[b(new Date(s.created_at),"MM/dd/yy"),e.jsx("div",{className:"text-xs text-muted-foreground",children:b(new Date(s.created_at),"h:mm a")})]}),e.jsxs(x,{children:[e.jsx("div",{className:"font-medium",children:s.account?.name||"-"}),s.account?.address&&e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(fe,{className:"h-3 w-3"}),s.account.address.slice(0,30),"..."]})]}),e.jsx(x,{children:s.type==="shovel"&&s.teamMemberNames&&s.teamMemberNames.length>0?s.teamMemberNames.join(", "):s.employee?`${s.employee.first_name} ${s.employee.last_name}`:"-"}),e.jsx(x,{children:z(s)}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(ce,{className:"h-3 w-3 text-muted-foreground"}),k(s.check_in_time,s.check_out_time)]})}),e.jsx(x,{children:J(s.status)}),e.jsx(x,{children:e.jsxs("div",{className:"text-xs text-muted-foreground space-y-0.5",children:[s.type==="plow"&&s.salt_used_lbs&&e.jsxs("div",{children:["Salt: ",s.salt_used_lbs," lbs"]}),s.type==="plow"&&s.snow_depth_inches&&e.jsxs("div",{children:["Snow: ",s.snow_depth_inches,'"']}),s.type==="shovel"&&s.ice_melt_used_lbs&&e.jsxs("div",{children:["Ice Melt: ",s.ice_melt_used_lbs," lbs"]}),s.equipment?.name&&e.jsxs("div",{children:["Equip: ",s.equipment.name]})]})})]},s.id))})]})})})]})})]})]})})}export{Le as default};
