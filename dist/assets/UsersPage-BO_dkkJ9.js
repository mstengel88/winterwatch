import{r as n,j as e,L as h,C as T,Q as E,R as U,an as $,$ as L,g as k,B as A,S as B,p as q,q as z,t as F,v as H,k as P,ao as V,s as c,V as o,a8 as I,E as M,M as D,_ as O,ap as Q}from"./index-CnGaZqSN.js";import{T as W,a as G,b as N,c as x,d as J,e as u}from"./table-Cg0xew9Q.js";import{T as K}from"./trash-2-CZ7AlvHE.js";const X=["admin","manager","driver","shovel_crew","client"],Y=t=>{switch(t){case"admin":return e.jsx(Q,{className:"h-3 w-3"});case"manager":return e.jsx(O,{className:"h-3 w-3"});case"driver":return e.jsx(D,{className:"h-3 w-3"});case"shovel_crew":return e.jsx(M,{className:"h-3 w-3"});default:return e.jsx(I,{className:"h-3 w-3"})}},Z=t=>{switch(t){case"admin":return"bg-destructive text-destructive-foreground";case"manager":return"bg-warning text-warning-foreground";case"driver":return"bg-plow text-plow-foreground";case"shovel_crew":return"bg-shovel text-shovel-foreground";default:return"bg-secondary text-secondary-foreground"}};function ae(){const[t,R]=n.useState([]),[y,j]=n.useState(!0),[f,g]=n.useState(null),[C,p]=n.useState(null),[i,w]=n.useState({}),d=async()=>{j(!0);try{const{data:s,error:r}=await c.from("profiles").select("*").order("created_at",{ascending:!1});if(r)throw r;const{data:a,error:l}=await c.from("user_roles").select("user_id, role");if(l)throw l;const _=(s||[]).map(v=>({...v,roles:(a||[]).filter(m=>m.user_id===v.id).map(m=>m.role)}));R(_)}catch(s){console.error("Error fetching users:",s),o.error("Failed to load users")}finally{j(!1)}};n.useEffect(()=>{d()},[]);const S=async s=>{const r=i[s];if(!r){o.error("Please select a role");return}g({userId:s,role:r});try{const{error:a}=await c.from("user_roles").insert({user_id:s,role:r});if(a){if(a.code==="23505")o.error("User already has this role");else throw a;return}o.success(`Added ${r} role`),w(l=>({...l,[s]:""})),d()}catch(a){console.error("Error adding role:",a),o.error("Failed to add role")}finally{g(null)}},b=async(s,r)=>{const a=`${s}-${r}`;p(a);try{const{error:l}=await c.from("user_roles").delete().eq("user_id",s).eq("role",r);if(l)throw l;o.success(`Removed ${r} role`),d()}catch(l){console.error("Error removing role:",l),o.error("Failed to remove role")}finally{p(null)}};return y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(h,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Users & Roles"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage user accounts and assign roles"})]}),e.jsxs(T,{children:[e.jsxs(E,{children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"All Users"]}),e.jsxs(L,{children:[t.length," registered user",t.length!==1?"s":""]})]}),e.jsx(k,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(W,{children:[e.jsx(G,{children:e.jsxs(N,{children:[e.jsx(x,{children:"User"}),e.jsx(x,{children:"Current Roles"}),e.jsx(x,{children:"Add Role"})]})}),e.jsx(J,{children:t.map(s=>e.jsxs(N,{children:[e.jsx(u,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.full_name||"No name"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.email})]})}),e.jsx(u,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:s.roles.length>0?s.roles.map(r=>e.jsxs(A,{className:`${Z(r)} cursor-pointer`,onClick:()=>b(s.id,r),children:[Y(r),e.jsx("span",{className:"ml-1 capitalize",children:r.replace("_"," ")}),C===`${s.id}-${r}`?e.jsx(h,{className:"ml-1 h-3 w-3 animate-spin"}):e.jsx(K,{className:"ml-1 h-3 w-3"})]},r)):e.jsx("span",{className:"text-sm text-muted-foreground",children:"No roles"})})}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(B,{value:i[s.id]||"",onValueChange:r=>w(a=>({...a,[s.id]:r})),children:[e.jsx(q,{className:"w-[140px]",children:e.jsx(z,{placeholder:"Select role"})}),e.jsx(F,{children:X.filter(r=>!s.roles.includes(r)).map(r=>e.jsx(H,{value:r,children:e.jsx("span",{className:"capitalize",children:r.replace("_"," ")})},r))})]}),e.jsx(P,{size:"sm",onClick:()=>S(s.id),disabled:!i[s.id]||f?.userId===s.id,children:f?.userId===s.id?e.jsx(h,{className:"h-4 w-4 animate-spin"}):e.jsx(V,{className:"h-4 w-4"})})]})})]},s.id))})]})})})]})]})}export{ae as default};
