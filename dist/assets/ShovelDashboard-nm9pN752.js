import{c as qe,u as Ce,a as Le,r as t,s as C,b as $e,d as Ge,e as Ve,f as Be,j as e,L as je,A as Ne,C as U,g as R,h as Je,B as be,i as se,k as j,l as ye,m as ze,N as we,n as ke,o as x,S as He,p as Ze,q as Ke,t as Qe,v as Ye,P as Xe,w as te,T as es,x as ss,y as ts,I as q,z as as,D as rs,E as Se,F as _e}from"./index-CnGaZqSN.js";const ae=qe("Footprints",[["path",{d:"M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z",key:"1dudjm"}],["path",{d:"M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z",key:"l2t8xc"}],["path",{d:"M16 17h4",key:"1dejxt"}],["path",{d:"M4 13h4",key:"1bwh8b"}]]);function cs(){const{employee:p}=Ce(),{getCurrentLocation:L}=Le(),[n,J]=t.useState([]),[N,b]=t.useState(null),[D,l]=t.useState([]),[y,$]=t.useState(!0),[z,f]=t.useState(null),F=t.useCallback(async()=>{try{const{data:r,error:c}=await C.from("accounts").select("*").eq("is_active",!0).in("service_type",["shovel","both"]).order("priority",{ascending:!0}).order("name",{ascending:!0});if(c)throw c;J(r||[])}catch(r){console.error("Error fetching accounts:",r),f("Failed to load accounts")}},[]),m=t.useCallback(async()=>{if(!p){b(null);return}try{const{data:r,error:c}=await C.from("shovel_work_logs").select(`
          *,
          account:accounts(*)
        `).eq("employee_id",p.id).eq("status","in_progress").order("check_in_time",{ascending:!1}).limit(1).single();if(c&&c.code!=="PGRST116")throw c;b(r)}catch(r){console.error("Error fetching active shovel work log:",r)}},[p]),u=t.useCallback(async()=>{if(!p){l([]);return}try{const r=new Date;r.setHours(0,0,0,0);const{data:c,error:o}=await C.from("shovel_work_logs").select(`
          *,
          account:accounts(*)
        `).eq("employee_id",p.id).gte("created_at",r.toISOString()).order("created_at",{ascending:!1}).limit(10);if(o)throw o;l(c||[])}catch(r){console.error("Error fetching recent shovel work logs:",r)}},[p]);return t.useEffect(()=>{(async()=>($(!0),await F(),await m(),await u(),$(!1)))()},[F,m,u]),{accounts:n,activeWorkLog:N,recentWorkLogs:D,isLoading:y,error:z,checkIn:async(r,c="shovel",o)=>{if(!p)return f("No employee record found"),!1;const w=await L();try{const{data:M,error:G}=await C.from("shovel_work_logs").insert({account_id:r,employee_id:p.id,service_type:c,status:"in_progress",check_in_time:new Date().toISOString(),check_in_latitude:w?.latitude??null,check_in_longitude:w?.longitude??null,team_member_ids:o&&o.length>0?o:null}).select(`
          *,
          account:accounts(*)
        `).single();if(G)throw G;return b(M),await u(),!0}catch(M){return console.error("Error checking in:",M),f("Failed to check in"),!1}},checkOut:async r=>{if(!N)return f("No active work log found"),!1;const c=await L();try{const{error:o}=await C.from("shovel_work_logs").update({status:"completed",check_out_time:new Date().toISOString(),check_out_latitude:c?.latitude??null,check_out_longitude:c?.longitude??null,areas_cleared:r.areasCleared??null,ice_melt_used_lbs:r.iceMeltUsedLbs??null,snow_depth_inches:r.snowDepthInches??null,weather_conditions:r.weatherConditions??null,notes:r.notes??null,photo_urls:r.photoUrls??null}).eq("id",N.id);if(o)throw o;return b(null),await u(),!0}catch(o){return console.error("Error checking out:",o),f("Failed to check out"),!1}},updateActiveWorkLog:async r=>{if(!N)return f("No active work log found"),!1;try{const c={};r.teamMemberIds!==void 0&&(c.team_member_ids=r.teamMemberIds.length>0?r.teamMemberIds:null),r.serviceType!==void 0&&(c.service_type=r.serviceType);const{data:o,error:w}=await C.from("shovel_work_logs").update(c).eq("id",N.id).select(`
          *,
          account:accounts(*)
        `).single();if(w)throw w;return b(o),!0}catch(c){return console.error("Error updating work log:",c),f("Failed to update work log"),!1}},refreshData:async()=>{await F(),await m(),await u()}}}function os(){const{profile:p}=$e(),{employee:L,activeShift:n,isLoading:J,clockIn:N,clockOut:b}=Ce(),{accounts:D,activeWorkLog:l,recentWorkLogs:y,isLoading:$,checkIn:z,checkOut:f,updateActiveWorkLog:F}=cs(),{location:m,getCurrentLocation:u,isLoading:A}=Le(),{photos:H,previews:re,isUploading:W,uploadProgress:r,addPhotos:c,removePhoto:o,clearPhotos:w,uploadPhotos:M,canAddMore:G}=Ge({folder:"shovel-logs"}),{toast:d}=Ve(),[v,ce]=t.useState(""),[i,Z]=t.useState("shovel"),[h,le]=t.useState([]),[T,ne]=t.useState(""),[E,oe]=t.useState(""),[P,Te]=t.useState("31"),[O,Ee]=t.useState("Cloudy"),[V,Ie]=t.useState("11"),[ie,de]=t.useState(""),[K,he]=t.useState({hours:0,minutes:0,seconds:0}),[Q,ue]=t.useState({hours:0,minutes:0,seconds:0}),[me,De]=t.useState([]),g=n?`shovel-team-${n.id}`:null,[xe,pe]=t.useState(!1);t.useEffect(()=>{if(g&&!xe){const s=localStorage.getItem(g);if(s)try{const a=JSON.parse(s);Array.isArray(a)&&a.length>0&&le(a)}catch{}pe(!0)}g||pe(!1)},[g,xe]),t.useEffect(()=>{g&&h.length>0&&localStorage.setItem(g,JSON.stringify(h))},[g,h]);const fe=t.useRef(n?.id??null);t.useEffect(()=>{const s=fe.current,a=n?.id??null;s&&!a&&localStorage.removeItem(`shovel-team-${s}`),fe.current=a},[n?.id]),t.useEffect(()=>{u();const s=setInterval(()=>{u()},3e4);return()=>clearInterval(s)},[u]),t.useEffect(()=>{(async()=>{const{data:a,error:S}=await C.from("employees").select("*").in("category",["shovel","both"]).eq("is_active",!0).order("first_name");!S&&a&&De(a)})()},[]),t.useEffect(()=>{if(!n){he({hours:0,minutes:0,seconds:0});return}const s=()=>{const S=new Date(n.clock_in_time),_=_e(new Date,S),Y=Math.floor(_/3600),X=Math.floor(_%3600/60),ee=_%60;he({hours:Y,minutes:X,seconds:ee})};s();const a=setInterval(s,1e3);return()=>clearInterval(a)},[n]),t.useEffect(()=>{if(!l||!l.check_in_time){ue({hours:0,minutes:0,seconds:0});return}const s=()=>{const S=new Date(l.check_in_time),_=_e(new Date,S),Y=Math.floor(_/3600),X=Math.floor(_%3600/60),ee=_%60;ue({hours:Y,minutes:X,seconds:ee})};s();const a=setInterval(s,1e3);return()=>clearInterval(a)},[l]);const B=t.useMemo(()=>m?D.map(s=>{if(s.latitude&&s.longitude){const a=Be(m.latitude,m.longitude,s.latitude,s.longitude);return{account:s,distance:a}}return{account:s,distance:null}}).sort((s,a)=>s.distance===null&&a.distance===null?0:s.distance===null?1:a.distance===null?-1:s.distance-a.distance):D.map(s=>({account:s,distance:null})),[m,D]),k=t.useMemo(()=>{if(B.length===0)return null;const s=B[0];return s.distance!==null?s:null},[B]);t.useEffect(()=>{k&&!v&&ce(k.account.id)},[k,v]);const Fe=t.useCallback(async()=>{await u(),d({title:"Location updated"})},[u,d]),Ae=async()=>{const s=await N();d(s?{title:"Shift started successfully!"}:{variant:"destructive",title:"Failed to start shift"})},We=async()=>{const s=await b();d(s?{title:"Shift ended successfully!"}:{variant:"destructive",title:"Failed to end shift"})},ge=async()=>{if(!v){d({variant:"destructive",title:"Please select an account"});return}const a=await z(v,i==="salt"?"ice_melt":i,h);d(a?{title:"Checked in at account!"}:{variant:"destructive",title:"Failed to check in"})},Me=async()=>{let s=[];H.length>0&&l&&(s=await M(l.id)),await f({areasCleared:[],iceMeltUsedLbs:E?parseFloat(E):void 0,snowDepthInches:T?parseFloat(T):void 0,notes:ie||void 0,weatherConditions:O||void 0,photoUrls:s.length>0?s:void 0})?(g&&h.length>0&&localStorage.setItem(g,JSON.stringify(h)),d({title:"Work completed!"}),de(""),oe(""),ne(""),w()):d({variant:"destructive",title:"Failed to check out"})},Pe=async()=>{l?await Me():await ge()},Oe=s=>{le(a=>a.includes(s)?a.filter(S=>S!==s):[...a,s])},ve=t.useMemo(()=>!(!v||h.length===0||i!=="salt"&&(!T||T.trim()==="")||i!=="shovel"&&(!E||E.trim()==="")||!P||P.trim()===""||!O||O.trim()===""||!V||V.trim()===""),[v,h,T,E,P,O,V,i]);if(J||$)return e.jsx("div",{className:"flex min-h-screen items-center justify-center bg-background",children:e.jsx(je,{className:"h-8 w-8 animate-spin text-purple-500"})});if(!L)return e.jsx(Ne,{children:e.jsx(U,{className:"border-yellow-500/50 bg-yellow-500/5",children:e.jsxs(R,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-yellow-500",children:[e.jsx(Je,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Employee Record Not Found"})]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Your user account is not linked to an employee record. Please contact your manager."})]})})});const Ue=`${L.first_name} ${L.last_name}`;y.filter(s=>s.status==="completed").length,y.filter(s=>s.service_type==="shovel"||s.service_type==="both").length,y.filter(s=>s.service_type==="ice_melt"||s.service_type==="salt").length;const I=s=>s.toString().padStart(2,"0");return e.jsx(Ne,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-purple-500/20 flex items-center justify-center",children:e.jsx(ae,{className:"h-5 w-5 text-purple-400"})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Shovel Crew"}),e.jsxs(be,{variant:"outline",className:"bg-[hsl(var(--card))]/50 border-border/50 text-muted-foreground",children:[P,"°F"]})]}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:["Welcome back, ",Ue,"! Track your shovel crew services."]})]}),e.jsx(U,{className:"bg-[hsl(var(--card))]/80 border-border/50",children:e.jsx(R,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-purple-500/20 flex items-center justify-center",children:e.jsx(se,{className:"h-5 w-5 text-purple-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Daily Shift"}),n?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xl font-mono font-bold text-purple-400",children:[I(K.hours),":",I(K.minutes),":",I(K.seconds)]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"elapsed"})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Shift not started"})]})]}),n?e.jsxs(j,{onClick:We,variant:"outline",className:"border-red-500/50 text-red-400 hover:bg-red-500/20",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"End Shift"]}):e.jsxs(j,{onClick:Ae,className:"bg-purple-600 hover:bg-purple-700",children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Start Shift"]})]})})}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-base font-semibold",children:"Quick Log Entry"}),e.jsxs("div",{className:"bg-purple-600 rounded-lg p-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{className:"h-5 w-5 text-purple-200"}),e.jsx("div",{children:k?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"font-medium text-white",children:[e.jsx("span",{className:"text-purple-200",children:"Nearest:"})," ",k.account.name," ",e.jsx("span",{className:"text-purple-200",children:k.distance!==null?ke(k.distance):""})]}),e.jsxs("p",{className:"text-sm text-purple-200",children:["GPS accuracy: ±",m?.accuracy?Math.round(m.accuracy):"--"," meters"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"font-medium text-white",children:A?"Getting location...":"Location unavailable"}),e.jsx("p",{className:"text-sm text-purple-200",children:A?"Please wait":"Enable GPS to find nearest account"})]})})]}),e.jsx("button",{onClick:Fe,disabled:A,className:"p-2 rounded-full hover:bg-purple-500/30 transition-colors disabled:opacity-50",children:e.jsx(we,{className:`h-5 w-5 text-white ${A?"animate-pulse":""}`})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm text-muted-foreground",children:"Select Account (verify or change)"}),e.jsxs(He,{value:v,onValueChange:ce,disabled:!!l,children:[e.jsx(Ze,{className:"bg-[hsl(var(--card))]/80 border-border/50",children:e.jsx(Ke,{placeholder:"Select nearest account"})}),e.jsx(Qe,{className:"bg-[hsl(var(--card))] border-border",children:B.filter(({account:s})=>s.id&&s.id.trim()!=="").map(({account:s,distance:a})=>e.jsx(Ye,{value:s.id,children:e.jsxs("span",{className:"flex items-center justify-between w-full gap-2",children:[e.jsx("span",{children:s.name}),a!==null&&e.jsx("span",{className:"text-muted-foreground text-xs",children:ke(a)})]})},s.id))})]})]}),!l&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{className:"w-full bg-purple-600 hover:bg-purple-700",onClick:ge,disabled:!n||!v,children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Check In & Start Timer"]}),!n&&e.jsxs("p",{className:"text-center text-sm",children:[e.jsx("span",{className:"text-red-400",children:"Start your "}),e.jsx("span",{className:"text-yellow-400",children:"daily shift"}),e.jsx("span",{className:"text-red-400",children:" first via Time Clock"})]})]}),l&&e.jsx(U,{className:"border-green-500/50 bg-green-500/10",children:e.jsx(R,{className:"py-3 px-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-400",children:"Currently working at location"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Started ",l.check_in_time?te(new Date(l.check_in_time),"h:mm a"):"Unknown"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-green-400"}),e.jsxs("span",{className:"text-lg font-mono font-bold text-green-400",children:[I(Q.hours),":",I(Q.minutes),":",I(Q.seconds)]})]})]})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm",children:["Service Type ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs(j,{variant:i==="shovel"?"default":"ghost",className:i==="shovel"?"bg-purple-600 hover:bg-purple-700 text-white":"bg-transparent hover:bg-muted/30",onClick:()=>Z("shovel"),children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Shovel Walks"]}),e.jsxs(j,{variant:i==="salt"?"default":"ghost",className:i==="salt"?"bg-purple-600 hover:bg-purple-700 text-white":"bg-transparent hover:bg-muted/30",onClick:()=>Z("salt"),children:[e.jsx(ss,{className:"h-4 w-4 mr-2"}),"Salt Walks"]}),e.jsxs(j,{variant:i==="both"?"default":"ghost",className:i==="both"?"bg-purple-600 hover:bg-purple-700 text-white":"bg-transparent hover:bg-muted/30",onClick:()=>Z("both"),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Shovel/Salt Walks"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(x,{className:"text-sm flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4"}),"Team Members ",e.jsx("span",{className:"text-red-400",children:"*"})]}),l&&h.length>0&&e.jsx(j,{size:"sm",variant:"outline",className:"h-7 text-xs border-purple-500/50 text-purple-400 hover:bg-purple-500/20",onClick:async()=>{const a=await F({teamMemberIds:h,serviceType:i==="salt"?"ice_melt":i});d(a?{title:"Team updated!"}:{variant:"destructive",title:"Failed to update team"})},children:"Save Changes"})]}),!l&&h.length===0&&e.jsx("p",{className:"text-xs text-amber-400",children:"Select at least one team member to check in"}),e.jsx(U,{className:"bg-[hsl(var(--card))]/50 border-border/30",children:e.jsx(R,{className:"py-3 space-y-2",children:me.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No shovel crew members found"}):me.map(s=>e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",onClick:()=>Oe(s.id),children:[e.jsx(ts,{checked:h.includes(s.id),className:"border-purple-500 data-[state=checked]:bg-purple-600"}),e.jsxs("span",{className:"text-sm",children:[s.first_name," ",s.last_name]})]},s.id))})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm",children:["Snow Depth (inches) ",i!=="salt"&&e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(q,{placeholder:"e.g., 3.5",value:T,onChange:s=>ne(s.target.value),className:"bg-[hsl(var(--card))]/50 border-border/30"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm",children:["Salt Used (lbs) ",i!=="shovel"&&e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(q,{placeholder:"e.g., 50",value:E,onChange:s=>oe(s.target.value),className:"bg-[hsl(var(--card))]/50 border-border/30"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm",children:["Temp (°F) ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(q,{value:P,onChange:s=>Te(s.target.value),className:"bg-[hsl(var(--card))]/50 border-border/30"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm",children:["Weather ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(q,{value:O,onChange:s=>Ee(s.target.value),className:"bg-[hsl(var(--card))]/50 border-border/30"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm",children:["Wind (mph) ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(q,{value:V,onChange:s=>Ie(s.target.value),className:"bg-[hsl(var(--card))]/50 border-border/30"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm",children:"Notes (Optional)"}),e.jsx(as,{placeholder:"Any additional notes...",value:ie,onChange:s=>de(s.target.value),className:"bg-[hsl(var(--card))]/50 border-border/30 min-h-[80px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm",children:"Photo (Optional)"}),e.jsx(rs,{photos:H,previews:re,isUploading:W,uploadProgress:r,canAddMore:G,onAddPhotos:c,onRemovePhoto:o})]}),e.jsx(j,{onClick:Pe,disabled:!n||!ve||W,className:`w-full py-6 text-lg font-semibold transition-colors ${!n||!ve||W?"bg-muted text-muted-foreground cursor-not-allowed":"bg-purple-600 hover:bg-purple-700 text-white"}`,children:W?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-5 w-5 mr-2 animate-spin"}),"Uploading Photos..."]}):l?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"h-5 w-5 mr-2"}),"Complete & Log Service"]}):e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"h-5 w-5 mr-2"}),"Log Service"]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-base font-semibold",children:"Recent Activity"}),e.jsx(U,{className:"bg-[hsl(var(--card))]/50 border-border/30 min-h-[300px]",children:e.jsx(R,{className:"py-6",children:y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(se,{className:"h-8 w-8 text-muted-foreground mb-3"}),e.jsx("p",{className:"font-medium text-muted-foreground",children:"No activity yet"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start logging your work!"})]}):e.jsx("div",{className:"space-y-3",children:y.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-purple-500/20 flex items-center justify-center",children:e.jsx(Se,{className:"h-4 w-4 text-purple-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.account?.name||"Unknown"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.check_in_time&&te(new Date(s.check_in_time),"h:mm a"),s.check_out_time&&` - ${te(new Date(s.check_out_time),"h:mm a")}`]})]})]}),e.jsx(be,{variant:"outline",className:s.status==="completed"?"bg-green-500/20 text-green-400 border-green-500/30":"bg-yellow-500/20 text-yellow-400 border-yellow-500/30",children:s.status==="completed"?"Done":"Active"})]},s.id))})})})]})]})]})})}export{os as default};
